<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GitHub 画像一覧</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 20px; }
    header { display:flex; gap:12px; flex-wrap:wrap; align-items:baseline; }
    .muted { color:#666; font-size: 12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; margin-top: 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; overflow:hidden; background:#fff; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .thumb { aspect-ratio: 4/3; display:flex; align-items:center; justify-content:center; background:#fafafa; }
    .thumb img { width: 100%; height: 100%; object-fit: contain; }
    .meta { padding: 10px; display:flex; flex-direction:column; gap: 8px; }
    .path { font-size: 12px; word-break: break-all; }
    .row { display:flex; gap: 8px; }
    input { flex:1; font-size: 12px; padding: 8px; border:1px solid #ddd; border-radius: 10px; }
    button { padding: 8px 10px; border:1px solid #ddd; border-radius: 10px; background:#f7f7f7; cursor:pointer; }
    button:hover { background:#efefef; }
    .status { margin-top: 10px; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background:#f2f2f2; font-size: 12px; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0;">GitHub 画像一覧</h2>
    <span class="pill" id="repoLabel"></span>
    <span class="muted">画像ファイル名（パス）とURLを表示。ボタンでコピー。</span>
  </header>

  <div class="status" id="status">読み込み中…</div>
  <div class="grid" id="grid"></div>

<script>
/** ====== ここを自分のリポジトリに合わせて変更 ====== */
const OWNER = "YOUR_OWNER";
const REPO  = "YOUR_REPO";
const BRANCH = "main";              // 例: main / master
const BASE_PATH = "";               // 例: "images"（フォルダ配下だけ見たいなら）
/** URL生成方式：raw or jsdelivr（public推奨） */
const URL_MODE = "jsdelivr";        // "raw" or "jsdelivr"
/** 対象拡張子 */
const IMG_EXT = /\.(png|jpe?g|gif|webp|svg)$/i;
/** ================================================ */

const statusEl = document.getElementById("status");
const gridEl = document.getElementById("grid");
document.getElementById("repoLabel").textContent = `${OWNER}/${REPO}@${BRANCH}${BASE_PATH ? " / " + BASE_PATH : ""}`;

function buildImageUrl(path) {
  const cleanPath = path.replace(/^\/+/, "");
  if (URL_MODE === "raw") {
    return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${cleanPath}`;
  }
  // jsDelivr (publicリポジトリ向け / 速い・CDN)
  return `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${BRANCH}/${cleanPath}`;
}

async function copy(text) {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch (e) {
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }
}

function card(path, url) {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <div class="thumb"><img alt="" loading="lazy"></div>
    <div class="meta">
      <div class="path">${path}</div>
      <div class="row">
        <input type="text" value="${url}" readonly />
        <button type="button">コピー</button>
      </div>
    </div>
  `;
  const img = div.querySelector("img");
  img.src = url;
  const btn = div.querySelector("button");
  btn.onclick = async () => {
    const ok = await copy(url);
    btn.textContent = ok ? "コピー済" : "失敗";
    setTimeout(() => (btn.textContent = "コピー"), 900);
  };
  // クリックで画像URLをコピー（おまけ）
  img.style.cursor = "pointer";
  img.title = "クリックでURLコピー";
  img.onclick = () => btn.click();
  return div;
}

async function fetchJson(url) {
  const res = await fetch(url, {
    headers: {
      "Accept": "application/vnd.github+json",
    }
  });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

async function run() {
  try {
    statusEl.textContent = "GitHubからファイル一覧を取得中…";

    // 1) branch情報から tree sha を取得
    const branchInfo = await fetchJson(`https://api.github.com/repos/${OWNER}/${REPO}/branches/${BRANCH}`);
    const treeSha = branchInfo?.commit?.commit?.tree?.sha;
    if (!treeSha) throw new Error("tree sha を取得できませんでした（ブランチ名やリポジトリを確認）");

    // 2) treeを再帰で取得
    statusEl.textContent = "ツリーを再帰取得中…";
    const tree = await fetchJson(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${treeSha}?recursive=1`);

    if (tree.truncated) {
      statusEl.innerHTML = `<span class="error">注意：</span>ファイル数が多すぎて一覧が省略されました（truncated=true）。`;
    }

    // 3) blob（ファイル）だけ、画像拡張子だけ、BASE_PATH配下だけに絞る
    const base = BASE_PATH.replace(/^\/+|\/+$/g, ""); // trim /
    const list = (tree.tree || [])
      .filter(x => x.type === "blob" && IMG_EXT.test(x.path))
      .filter(x => !base || x.path.startsWith(base + "/") || x.path === base);

    // 4) 表示
    gridEl.innerHTML = "";
    if (!list.length) {
      statusEl.textContent = "画像が見つかりませんでした（拡張子 or BASE_PATH を確認）";
      return;
    }
    statusEl.textContent = `画像 ${list.length} 件を表示中…`;

    for (const item of list) {
      const url = buildImageUrl(item.path);
      gridEl.appendChild(card(item.path, url));
    }

    statusEl.textContent = `完了：画像 ${list.length} 件`;
  } catch (e) {
    statusEl.innerHTML = `<span class="error">エラー：</span>${String(e.message || e)}`;
  }
}

run();
</script>
</body>
</html>
